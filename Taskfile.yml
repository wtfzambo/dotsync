version: '3'

vars:
  BINARY:
    sh: "{{if eq OS `windows`}}echo dotsync.exe{{else}}echo dotsync{{end}}"
  BUILD_DIR: bin
  GIT_VERSION:
    sh: "git describe --tags --always --dirty 2>/dev/null || echo dev"
  GIT_COMMIT:
    sh: "git rev-parse --short HEAD 2>/dev/null || echo none"
  BUILD_DATE:
    sh: 'echo {{now | date "2006-01-02T15:04:05Z"}}'

tasks:
  default:
    desc: Build the binary
    cmds:
      - task: build

  build:
    desc: Build the binary with optimizations
    cmds:
      - go build -ldflags "-s -w -X main.version={{.GIT_VERSION}} -X main.commit={{.GIT_COMMIT}} -X main.date={{.BUILD_DATE}} -X main.builtBy=task" -o {{.BUILD_DIR}}/{{.BINARY}} ./cmd/dotsync
    sources:
      - '**/*.go'
    generates:
      - '{{.BUILD_DIR}}/{{.BINARY}}'

  dev:
    desc: Build the binary without optimizations (faster)
    cmds:
      - go build -ldflags "-X main.version=dev -X main.commit={{.GIT_COMMIT}} -X main.date={{.BUILD_DATE}} -X main.builtBy=task" -o {{.BUILD_DIR}}/{{.BINARY}} ./cmd/dotsync

  test:
    desc: Run all tests
    cmds:
      - go test -v ./...

  test:cover:
    desc: Run tests with coverage report
    cmds:
      - go test -v -coverprofile=coverage.out ./...
      - go tool cover -html=coverage.out -o coverage.html

  clean:
    desc: Clean build artifacts
    cmds:
      - "{{if eq OS `windows`}}powershell Remove-Item -Recurse -Force {{.BUILD_DIR}} -ErrorAction SilentlyContinue{{else}}rm -rf {{.BUILD_DIR}}{{end}}"
      - "{{if eq OS `windows`}}powershell Remove-Item -Force coverage.out, coverage.html -ErrorAction SilentlyContinue{{else}}rm -f coverage.out coverage.html{{end}}"

  tidy:
    desc: Tidy go modules
    cmds:
      - go mod tidy

  run:
    desc: Build and run the binary
    deps: [build]
    cmds:
      - "{{.BUILD_DIR}}/{{.BINARY}} {{.CLI_ARGS}}"

  install:
    desc: Install the binary to GOPATH/bin
    deps: [build]
    vars:
      GOPATH_BIN:
        sh: go env GOPATH
    cmds:
      - "{{if eq OS `windows`}}powershell Copy-Item {{.BUILD_DIR}}/{{.BINARY}} {{.GOPATH_BIN}}/bin/{{else}}cp {{.BUILD_DIR}}/{{.BINARY}} {{.GOPATH_BIN}}/bin/{{end}}"

  lint:
    desc: Run linters
    cmds:
      - golangci-lint run ./...
